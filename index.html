<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>検査予定 管理画面</title>

<style>
  body { font-family: sans-serif; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #999; padding: 4px; text-align: center; }
  th { background: #eee; }
  .duplicate { background-color: #ffb3b3; }
</style>
</head>

<body>

<h2>検査予定 管理画面</h2>

<div>
  開始日：
  <input type="date" id="from">
  終了日：
  <input type="date" id="to">
  <button onclick="loadData()">表示</button>
  <button onclick="downloadExcel()">Excel出力</button>
</div>

<table id="table">
  <thead>
    <tr>
      <th>業者名</th>
      <th>船番</th>
      <th>ブロック</th>
      <th>区画</th>
      <th>検査日</th>
      <th>時間</th>
      <th>検査場所</th>
      <th>備考</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxqdss65l9VQYnwxBMNHeghRCvH5gJncBA6m7jy6Ap7AWm20EPW_0pN94PQNKuQWIH3/exec";
let currentData = [];

function loadData() {
  const from = document.getElementById("from").value;
  const to   = document.getElementById("to").value;

  let url = GAS_URL;
  if (from && to) {
    url += `?from=${from}&to=${to}`;
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      currentData = data;
      renderTable(data);
    })
    .catch(() => {
      alert("データ取得に失敗しました");
    });
}

function renderTable(data) {
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  // 重複チェック用
  const map = {};
  data.forEach(d => {
    const key = `${d.date}_${d.time}_${d.place}`;
    map[key] = (map[key] || 0) + 1;
  });

  data.forEach(d => {
    const key = `${d.date}_${d.time}_${d.place}`;
    const tr = document.createElement("tr");

    if (map[key] > 1) {
      tr.classList.add("duplicate");
    }

    tr.innerHTML = `
      <td>${d.vendor}</td>
      <td>${d.shipNo}</td>
      <td>${d.block}</td>
      <td>${d.area}</td>
      <td>${d.date}</td>
      <td>${d.time}</td>
      <td>${d.place}</td>
      <td>${d.note}</td>
    `;
    tbody.appendChild(tr);
  });
}

function downloadExcel() {
  if (currentData.length === 0) {
    alert("データがありません");
    return;
  }

  let csv = "業者名,船番,ブロック,区画,検査日,時間,検査場所,備考\n";
  currentData.forEach(d => {
    csv += [
      d.vendor,
      d.shipNo,
      d.block,
      d.area,
      d.date,
      d.time,
      d.place,
      d.note
    ].join(",") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "社内検査予定.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
